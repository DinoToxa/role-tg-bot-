import telebot
from telebot.types import ChatPermissions
import sqlite3

TOKEN = '8341891718:AAHd458IwGuyv_crNt7R2eHdazOR0z1B5_k'
bot = telebot.TeleBot(TOKEN)

conn = sqlite3.connect('users.db', check_same_thread=False)
conn.execute('CREATE TABLE IF NOT EXISTS user_roles (username TEXT PRIMARY KEY, user_id INTEGER, role TEXT)')
conn.commit()

@bot.message_handler(commands=['help'])
def help_cmd(message):
    bot.send_message(message.chat.id, """–ü—Ä–∏–≤–µ—Ç, —è —É–º–µ—é –Ω–∞–∑–Ω–∞—á–∞—Ç—å —Ä–æ–ª–∏!
                     –£ –º–µ–Ω—è –µ—Å—Ç—å —Ç–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
                     /setrole @username role (–Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å)
                     
                     —Ä–æ–ª–∏:
                     admin - –∞–¥–º–∏–Ω –≥—Ä—É–ø–ø—ã
                     member - —É—á–∞—Å—Ç–Ω–∏–∫
                     mute - –Ω–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å
                     –º–Ω–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω—É–∂–Ω–∞ —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –ø—Ä–∞–≤–æ –Ω–∞–∑–Ω–∞—á–∞—Ç—å –¥—Ä—É–≥–∏—Ö""")

@bot.message_handler(commands=['get_user'])
def get_user_cmd(m):
    args = m.text.split()
    if len(args) > 1:
        username = args[1] if args[1].startswith('@') else '@' + args[1]
        result = conn.execute('SELECT role FROM user_roles WHERE username=?', (username,)).fetchone()
        bot.reply_to(m, f'{username}: {result[0] if result else "–Ω–µ –Ω–∞–π–¥–µ–Ω"}')
    else:
        bot.reply_to(m, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /get_user @username')

@bot.message_handler(commands=['get_roles'])
def get_roles_cmd(m):
    args = m.text.split()
    if len(args) > 1 and args[1] in ['admin','member','mute']:
        users = conn.execute('SELECT username FROM user_roles WHERE role=?', (args[1],)).fetchall()
        if users:
            response = f"{args[1]}:\n" + '\n'.join(u[0] for u in users)
        else:
            response = '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
        bot.reply_to(m, response)
    else:
        bot.reply_to(m, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /get_roles <admin|member|mute>')

@bot.message_handler(func=lambda m: True, content_types=['text'])
def handle_all(message):
    if message.from_user.username:
        username = f"@{message.from_user.username.lower()}"
        conn.execute('INSERT OR REPLACE INTO user_roles (username, user_id, role) VALUES (?, ?, COALESCE((SELECT role FROM user_roles WHERE username=?), "member"))',
                    (username, message.from_user.id, username))
        conn.commit()
    
    if message.text.startswith('/setrole'):
        parts = message.text.split()
        if len(parts) < 3:
            return bot.reply_to(message, "–ò—Å–ø–æ–ª—å–∑—É–π: /setrole @username role")

        username_input = parts[1]
        username = username_input if username_input.startswith('@') else '@' + username_input
        role = parts[2].lower()
        
        result = conn.execute('SELECT user_id FROM user_roles WHERE username=?', (username,)).fetchone()
        
        if not result:
            return bot.reply_to(message, f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å —Ö–æ—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ!")
        
        target_id = result[0]

        try:
            if role == 'admin':
                bot.promote_chat_member(message.chat.id, target_id, 
                    can_manage_chat=True, can_delete_messages=True, can_restrict_members=True)
                bot.set_chat_administrator_custom_title(message.chat.id, target_id, "–ê–¥–º–∏–Ω")
                bot.reply_to(message, f"‚ö°Ô∏è {username} —Ç–µ–ø–µ—Ä—å Admin!")
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å –≤ –ë–î
                conn.execute('UPDATE user_roles SET role=? WHERE username=?', (role, username))

            elif role == 'mute':
                bot.restrict_chat_member(message.chat.id, target_id, 
                    permissions=ChatPermissions(can_send_messages=False))
                bot.reply_to(message, f"üîá {username} –≤ –º—É—Ç–µ.")
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å –≤ –ë–î
                conn.execute('UPDATE user_roles SET role=? WHERE username=?', (role, username))

            elif role == 'member':
                bot.promote_chat_member(message.chat.id, target_id, can_manage_chat=False)
                bot.restrict_chat_member(message.chat.id, target_id, 
                    permissions=ChatPermissions(can_send_messages=True, can_send_media_messages=True))
                bot.reply_to(message, f"‚úÖ {username} —É—á–∞—Å—Ç–Ω–∏–∫.")
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å –≤ –ë–î
                conn.execute('UPDATE user_roles SET role=? WHERE username=?', (role, username))
            
            conn.commit()

        except Exception as e:
            bot.reply_to(message, f"–û—à–∏–±–∫–∞: {e}. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –±–æ—Ç ‚Äî –∞–¥–º–∏–Ω —Å –ø—Ä–∞–≤–æ–º –Ω–∞–∑–Ω–∞—á–∞—Ç—å –¥—Ä—É–≥–∏—Ö!")

bot.polling()
